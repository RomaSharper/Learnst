<!--suppress ALL -->
<mat-card class="profile-container" appearance="outlined">
  <a mat-button color="primary" class="mb" (click)="goBack()">Назад</a>

  @if (loading()) {
    <mat-spinner></mat-spinner>
  } @else if (!user()) {
    <div class="error">Пользователь не найден</div>
  } @else if (user()?.isHidden && currentUser()?.role !== Role.Admin) {
    <div class="profile-grid">
      <!-- Личные данные -->
      <div class="full-width">
        <mat-card>
          <h3 class="profile-header">
            Личные данные
            <small class="profile-hidden-notice">Профиль скрыт</small>
          </h3>
          <div class="avatar-container">
            <img
              oading="lazy"
              noDownloading
              class="avatar"
              [alt]="user()!.username"
              [src]="user()?.avatarUrl!"
              placeholder="/assets/icons/user-192x192.png"
            >
            <!-- Бейджик статуса -->
            <div class="status-badge" [ngClass]="StatusHelper.getStatusClass(user()!.status)"
                 [matTooltip]="StatusHelper.getStatusName(user()!.status)"></div>
          </div>

          <mat-card appearance="outlined" class="registration-card">
            <div class="card-content">
              @if (isVeteran) {
                <div class="veteran-container" matTooltip="Медалька даётся пользователям, зарегистрированным более года назад">
                  <div class="veteran-badge">
                    <mat-icon class="veteran-icon">military_tech</mat-icon>
                    <span>Ветеран</span>
                  </div>
                </div>
              }

              <div class="registration-info">
                <mat-icon class="calendar-icon">calendar_month</mat-icon>
                <div>
                  <div class="caption">Дата регистрации</div>
                  <div class="date">{{ user()?.createdAt | ruDate }}</div>
                </div>
              </div>
            </div>
          </mat-card>

          <div class="full-width">
            <p>{{ followersCount() | plural:'подписчик':'подписчика':'подписчиков' }}</p>
          </div>

          <div class="actions full-width mb-2">
            <button
              type="button"
              color="primary"
              mat-flat-button
              [disabled]="loading()"
              (click)="handleFollow()"
            >
              <mat-icon>{{ isFollowing() ? 'person_remove' : 'person_add' }}</mat-icon>
              {{ isFollowing() ? 'Отписаться' : 'Подписаться' }}
            </button>
          </div>

          <div class="user-info">
            <mat-form-field appearance="outline">
              <mat-label>Имя пользователя</mat-label>
              <input matInput id="username" [(ngModel)]="user()!.username" maxlength="20" minlength="3" required
                     readonly>
            </mat-form-field>
          </div>
        </mat-card>
      </div>
    </div>
  } @else {
    <div class="profile-grid">
      <!-- Личные данные -->
      <div class="full-width">
        <mat-card>
          <h3>
            Личные данные
            @if (user()!.externalLoginType) {
              <img
                noDownloading
                class="social-icon"
                placeholder="/assets/icons/placeholder.png"
                [alt]="SocialMediaPlatformHelper.getName(user()!.externalLoginType!)"
                [src]="SocialMediaPlatformHelper.getImagePath(user()!.externalLoginType!)"
                [matTooltip]="SocialMediaPlatformHelper.getName(user()!.externalLoginType!)"
              >
            }
          </h3>

          <div class="avatar-container">
            <img [src]="user()?.avatarUrl!" [alt]="user()!.username" class="avatar"
                 placeholder="/assets/icons/user-192x192.png" loading="lazy" noDownloading>
            <!-- Бейджик статуса -->
            <div class="status-badge" [ngClass]="StatusHelper.getStatusClass(user()!.status)"
                 [matTooltip]="StatusHelper.getStatusName(user()!.status)"></div>
          </div>

          <mat-card appearance="outlined" class="registration-card">
            <div class="card-content">
              @if (isVeteran) {
                <div class="veteran-section">
                  <div class="medal-container" matTooltip="Пользователь авторизован уже больше года">
                    <mat-icon class="medal-icon">military_tech</mat-icon>
                    <span class="veteran-text">Ветеран</span>
                  </div>
                </div>
              }
              <div class="registration-info">
                <div class="date-container">
                  <mat-icon class="calendar-icon">calendar_month</mat-icon>
                  <div class="date-content">
                    <span class="caption">Дата регистрации</span>
                    <span class="date">{{ user()!.createdAt | ruDate }}</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card>

          <div class="full-width">
            <p>{{ followersCount() | plural:'подписчик':'подписчика':'подписчиков' }}</p>
          </div>

          <div class="actions full-width mb-2">
            <button
              type="button"
              color="primary"
              mat-flat-button
              [disabled]="loading()"
              (click)="handleFollow()"
            >
              <mat-icon>{{ isFollowing() ? 'person_remove' : 'person_add' }}</mat-icon>
              {{ isFollowing() ? 'Отписаться' : 'Подписаться' }}
            </button>
          </div>
          <div class="user-info">
            @if (user()!.fullName && user()!.fullName !== '') {
              <mat-form-field appearance="outline">
                <mat-label>ФИО</mat-label>
                <input matInput id="fullname" [(ngModel)]="user()!.fullName" placeholder="Не указано" maxlength="48"
                       readonly>
              </mat-form-field>
            }
            <mat-form-field appearance="outline">
              <mat-label>Имя пользователя</mat-label>
              <input matInput id="username" [(ngModel)]="user()!.username" maxlength="20" minlength="3" required
                     readonly>
            </mat-form-field>
            @if (user()!.dateOfBirth) {
              <mat-form-field appearance="outline">
                <mat-label>Дата рождения</mat-label>
                <input matInput id="date" type="date" [(ngModel)]="user()!.dateOfBirth" required readonly>
              </mat-form-field>
            }
            @if (user()!.emailAddress) {
              <mat-form-field appearance="outline">
                <mat-label>Электронная почта</mat-label>
                <input matInput id="email" type="email" [(ngModel)]="user()!.emailAddress" required maxlength="255"
                       readonly>
              </mat-form-field>
            }
            @if (user()!.city && user()!.city !== '') {
              <mat-form-field appearance="outline">
                <mat-label>Город</mat-label>
                <input matInput id="city" [(ngModel)]="user()!.city" placeholder="Не указан" maxlength="50" readonly>
              </mat-form-field>
            }
            @if (user()!.resumeText && user()!.resumeText !== '') {
              <mat-form-field appearance="outline">
                <mat-label>Резюме</mat-label>
                <textarea matInput id="resume" [(ngModel)]="user()!.resumeText" maxlength="500" placeholder="Не указано"
                          rows="4" readonly></textarea>
              </mat-form-field>
            }
            @if (user()!.aboutMe && user()!.aboutMe !== '') {
              <mat-form-field appearance="outline">
                <mat-label>Обо мне</mat-label>
                <textarea matInput id="aboutMe" [(ngModel)]="user()!.aboutMe" maxlength="500"
                          placeholder="Изменить статус"
                          rows="4" readonly></textarea>
              </mat-form-field>
            }
          </div>
        </mat-card>
      </div>

      <!-- Социальные сети -->
      @if (user()!.socialMediaProfiles.length > 0) {
        <div>
          <mat-card>
            <h3>Социальные сети</h3>
            <div class="cards">
              @for (socialMediaProfile of user()!.socialMediaProfiles; track socialMediaProfile) {
                <div class="social-card" inspectable>
                  <a [href]="socialMediaProfile.url" target="_blank">
                    <img
                      noDownloading
                      [title]="socialMediaProfile.url"
                      [src]="SocialMediaPlatformHelper.getImagePath(socialMediaProfile.platform)"
                    >
                    <div>{{ SocialMediaPlatformHelper.getName(socialMediaProfile.platform) }}</div>
                  </a>
                </div>
              }
            </div>
          </mat-card>
        </div>
      }

      <!-- Образование -->
      @if (user()!.educations.length > 0) {
        <div>
          <mat-card>
            <h3>Образование</h3>
            <div class="cards">
              @for (education of user()!.educations; track education) {
                <div class="education-item">
                  <div><strong>Вуз:</strong> {{ education.institutionName }}</div>
                  <div><strong>Факультет:</strong> {{ education.degree }}</div>
                  <div><strong>Год выпуска:</strong> {{ education.graduationYear }}</div>
                </div>
              }
            </div>
          </mat-card>
        </div>
      }

      <!-- Опыт работы -->
      @if (user()!.workExperiences.length > 0) {
        <div class="full-width">
          <mat-card>
            <h3>Опыт работы</h3>
            <div class="cards">
              @for (job of user()!.workExperiences; track job) {
                <div class="work-item">
                  <div><strong>Компания:</strong> {{ job.companyName }}</div>
                  <div><strong>Должность:</strong> {{ job.position }}</div>
                  <div><strong>Период работы:</strong> {{ job.startDate | dateRange: job.endDate }}</div>
                  <div><strong>Описание:</strong> {{ job.description || 'Отсутствует' }}</div>
                </div>
              }
            </div>
          </mat-card>
        </div>
      }
    </div>
  }
</mat-card>
