<div class="subscription-widget">
  <!-- Статус платежа -->
  @if (paymentStatus()) {
    <mat-card class="payment-status" appearance="outlined">
      <mat-card-content>
        <div class="status-content">
          @switch (paymentStatus()) {
            @case ('pending') {
              <mat-spinner diameter="24"></mat-spinner>
              <span>Ожидание подтверждения платежа...</span>
            }
            @case ('success') {
              <mat-icon class="success-icon">check_circle</mat-icon>
              <span>Платёж успешно завершён!</span>
            }
            @case ('failed') {
              <mat-icon class="error-icon">error</mat-icon>
              <span>Ошибка проведения платежа</span>
            }
          }
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- История платежей -->
  @if (paymentHistory().length > 0) {
    <mat-card class="payment-history" appearance="outlined">
      <mat-card-header>
        <mat-card-title>История платежей</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <mat-list>
          @for (item of paymentHistory(); track item.id) {
            <mat-list-item>
              <mat-icon matListItemIcon>
                {{ item.status === 'succeeded' ? 'check_circle' : 'cancel' }}
              </mat-icon>
              <span matListItemTitle>
                {{ item.amount | currency:'RUB':'symbol':'1.2-2' }}
                - {{ item.date | ruDate }}
              </span>
              <span matListItemLine>
                Статус: {{ getStatusText(item.status) }}
              </span>
            </mat-list-item>
          }
        </mat-list>
      </mat-card-content>
    </mat-card>
  }

  <!-- Текущая подписка -->
  @if (currentSubscription() && currentSubscription()?.endDate && !loading()) {
    <mat-card class="current-subscription mb-2" appearance="outlined">
      <mat-card-header>
        <mat-card-title>Ваша подписка активна</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="subscription-info">
          <mat-list>
            <mat-list-item>
              <span matListItemTitle>Осталось дней</span>
              <span matListItemLine class="highlight">
                {{ getDaysRemaining(currentSubscription()?.endDate?.toString()) }}
              </span>
            </mat-list-item>

            <mat-list-item>
              <span matListItemTitle>Дата окончания</span>
              <span matListItemLine class="highlight">
                {{ currentSubscription()?.endDate | ruDate }}
              </span>
            </mat-list-item>
          </mat-list>
        </div>
      </mat-card-content>
    </mat-card>
  } @else if (!loading()) {
    <mat-card class="no-subscription mb-2" appearance="outlined">
      <mat-card-content class="no-subscription-content">
        <mat-icon class="warning-icon">warning</mat-icon>
        <p>Активная подписка отсутствует</p>
      </mat-card-content>
    </mat-card>
  }

  <!-- Выбор плана -->
  <mat-card class="plan-selection" appearance="outlined">
    <mat-card-header>
      <h3>Выберите тарифный план</h3>
    </mat-card-header>

    <mat-card-content>
      <div class="plan-cards">
        @for (plan of subscriptionPlans; track plan) {
          <mat-card
            inspectable
            appearance="outlined"
            class="plan-card touchable"
            (click)="selectPlan(plan.duration)"
            [class.selected]="selectedPlan() === plan.duration"
          >

            <mat-card-header>
              <mat-card-title>{{ plan.label }}</mat-card-title>
              @if (plan.discount > 0) {
                <mat-card-subtitle>
                  <span class="discount-badge">-{{ plan.discount }}%</span>
                </mat-card-subtitle>
              }
            </mat-card-header>

            <mat-card-content>
              <div class="price-container">
                <div class="plan-price">
                  {{ calculatePrice(plan.duration) | round: 2 }}₽ @if (plan.duration == 1) { / мес }
                </div>
                @if (plan.duration > 1) {
                  <div class="monthly-price">
                    {{ (calculatePrice(plan.duration) / plan.duration) | round: 2 }}₽ / мес
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>

      <button
        type="button"
        color="primary"
        mat-flat-button
        class="purchase-button"
        (click)="purchaseSubscription()"
        [disabled]="!selectedPlan() || loading()"
      >
        <div class="button-content">
          @if (loading()) {
            <mat-spinner diameter="24"></mat-spinner>
          } @else {
            <span>Оформить подписку</span>
          }
        </div>
      </button>
    </mat-card-content>
  </mat-card>
</div>
