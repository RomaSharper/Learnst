<mat-card class="profile-container" appearance="outlined">
  <a mat-button color="primary" (click)="goBack()">Назад</a>

  <h1>Управление профилем</h1>

  @if (!user) {
    <mat-spinner></mat-spinner>
  } @else {
    <div class="profile-grid">
      <!-- Личные данные -->
      <mat-card class="full-width" appearance="outlined">
        <h3>
          Личные данные
          @if (user.externalLoginType) {
            <img class="social-icon" [src]="SocialMediaPlatformHelper.getImagePath(user.externalLoginType)"
              [matTooltip]="SocialMediaPlatformHelper.getName(user.externalLoginType)"
              [alt]="SocialMediaPlatformHelper.getName(user.externalLoginType)"
              placeholder="/assets/icons/placeholder.png" noDownloading inspectable>
          }
        </h3>

        <div class="avatar-container">
          <input
            type="file"
            class="hidden"
            id="avatarInput"
            (change)="onFileSelected($event)"
            [accept]="isPremium() ? 'image/*' : 'image/png, image/jpeg, image/jpg'"
          >
          <img [src]="user.avatarUrl" [alt]="user.username" noDownloading
            (click)="openFilePicker()" class="avatar" matTooltip="Изменить аватар"
            placeholder="/assets/icons/user-192x192.png" matTooltipPosition="below">
        </div>

        <div class="full-width">
          <p>{{ followersCount() | plural:'подписчик':'подписчика':'подписчиков' }}</p>
        </div>

        <div class="user-info">
          <mat-form-field appearance="outline">
            <mat-label>ФИО</mat-label>
            <input matInput id="fullname" [(ngModel)]="user!.fullName" placeholder="Иванов Иван Иванович" maxlength="48"
              (input)="onUserInfoChange()">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Имя пользователя</mat-label>
            <input matInput id="username" [(ngModel)]="user!.username" placeholder="Имя пользователя" maxlength="20"
              minlength="3" (input)="onUserInfoChange()" required>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Дата рождения</mat-label>
            <input matInput id="date" [(ngModel)]="user!.dateOfBirth" placeholder="Выберите день рождения" readonly
              (dateChange)="onUserInfoChange()" [matDatepicker]="picker" [min]="minDate" [max]="maxDate">
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker [touchUi]="isMediumScreen"></mat-datepicker>
            <button type="button" mat-icon-button matTooltip="Очистить дату" class="clear-date-btn"
              (click)="clearDate()">
              <mat-icon>close</mat-icon>
            </button>
            <mat-hint>dd.mm.yyyy</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Электронная почта</mat-label>
            <input matInput id="email" type="email" [(ngModel)]="user!.emailAddress" placeholder="Электронная почта"
              maxlength="255" (input)="onUserInfoChange()">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Город</mat-label>
            <input matInput id="city" type="text" [(ngModel)]="user!.city" placeholder="Город" maxlength="50"
              (input)="onUserInfoChange()">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Резюме</mat-label>
            <textarea matInput id="resume" [(ngModel)]="user!.resumeText" maxlength="500"
              placeholder="Введите ваше резюме" rows="4" (input)="onUserInfoChange()"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Обо мне</mat-label>
            <textarea matInput id="aboutMe" [(ngModel)]="user!.aboutMe" maxlength="500" placeholder="Расскажите о себе"
              rows="4" (input)="onUserInfoChange()"></textarea>
          </mat-form-field>
        </div>
      </mat-card>

      <!-- Изменить пароль -->
      <mat-card appearance="outlined">
        <h3>Изменить пароль</h3>
        <mat-form-field appearance="outline">
          <mat-label>Старый пароль</mat-label>
          <input
            matInput
            maxlength="50"
            autocomplete="off"
            [(ngModel)]="oldPassword"
            placeholder="Введите старый пароль"
            [type]="hidePassword ? 'password' : 'text'"
          >
          <!-- Иконка "глазика" -->
          <button
            matSuffix
            type="button"
            mat-icon-button
            class="input-button"
            (click)="hidePassword = !hidePassword"
            [attr.aria-label]="hidePassword ? 'Показать пароль' : 'Скрыть пароль'"
          >
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Новый пароль</mat-label>
          <input
            matInput
            maxlength="50"
            autocomplete="off"
            [(ngModel)]="newPassword"
            placeholder="Введите новый пароль"
            [type]="hidePassword ? 'password' : 'text'"
          >
          <!-- Иконка "глазика" -->
          <button
            matSuffix
            type="button"
            mat-icon-button
            class="input-button"
            (click)="hidePassword = !hidePassword"
            [attr.aria-label]="hidePassword ? 'Показать пароль' : 'Скрыть пароль'"
          >
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
        </mat-form-field>
        <button type="button" mat-flat-button color="primary" class="full-width" (click)="changePassword()">
          @if (passwordChanging) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            Сохранить изменения
          }
        </button>
      </mat-card>

      <!-- Социальные сети -->
      <mat-card class="full-height" appearance="outlined">
        <h3>Социальные сети</h3>
        <button type="button" mat-flat-button color="primary" (click)="openSocialMediaModal()">
          Добавить профиль
        </button>
        <div class="cards">
          @for (socialMediaProfile of user.socialMediaProfiles; track socialMediaProfile) {
          <div class="social-card">
            <a [href]="socialMediaProfile.url" target="_blank">
              <img [src]="SocialMediaPlatformHelper.getImagePath(socialMediaProfile.platform)"
                [matTooltip]="socialMediaProfile.url" noDownloading>
              <div>{{ SocialMediaPlatformHelper.getName(socialMediaProfile.platform) }}</div>
            </a>
            <button type="button" class="more-button" mat-icon-button [matMenuTriggerFor]="socialMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #socialMenu="matMenu">
              <button type="button" mat-menu-item (click)="openSocialMediaModal(socialMediaProfile)">Изменить</button>
              <button type="button" mat-menu-item (click)="deleteSocialMedia(socialMediaProfile)">Удалить</button>
            </mat-menu>
          </div>
          }
        </div>
      </mat-card>

      <!-- Образование -->
      <mat-card class="full-height" appearance="outlined">
        <h3>Образование</h3>
        <button type="button" mat-flat-button color="primary" (click)="openEducationModal()">
          Добавить образование
        </button>
        <div class="cards">
          @for (education of user.educations; track education) {
          <div class="education-item">
            <div><strong>Вуз:</strong> {{ education.institutionName }}</div>
            <div><strong>Факультет:</strong> {{ education.degree }}</div>
            <div><strong>Год выпуска:</strong> {{ education.graduationYear }}</div>
            <button type="button" class="more-button" mat-icon-button [matMenuTriggerFor]="educationMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #educationMenu="matMenu">
              <button type="button" mat-menu-item (click)="openEducationModal(education)">Изменить</button>
              <button type="button" mat-menu-item (click)="deleteEducation(education)">Удалить</button>
            </mat-menu>
          </div>
          }
        </div>
      </mat-card>

      <!-- Опыт работы -->
      <mat-card class="full-height" appearance="outlined">
        <h3>Опыт работы</h3>
        <button type="button" mat-flat-button color="primary" (click)="openWorkExperienceModal()">
          Добавить опыт работы
        </button>
        <div class="cards">
          @for (job of user.workExperiences; track job) {
          <div class="work-item">
            <div><strong>Компания:</strong> {{ job.companyName }}</div>
            <div><strong>Должность:</strong> {{ job.position }}</div>
            <div><strong>Период работы:</strong> {{ job.startDate | dateRange: job.endDate }}</div>
            <div><strong>Описание:</strong> {{ job.description || 'Отсутствует' }}</div>
            <button type="button" class="more-button" mat-icon-button [matMenuTriggerFor]="workMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #workMenu="matMenu">
              <button type="button" mat-menu-item (click)="openWorkExperienceModal(job)">Изменить</button>
              <button type="button" mat-menu-item (click)="deleteWorkExperience(job)">Удалить</button>
            </mat-menu>
          </div>
          }
        </div>
      </mat-card>

      <!-- Импорт/Экспорт -->
      <mat-card class="full-width" appearance="outlined">
        <h3>Импорт и экспорт данных</h3>
        <p>
          Экспортируются следующие данные: ФИО, аватар, дата рождения, электронная почта, город,
          резюме, информация о себе, имя пользователя, тема оформления, баннер, фон, образование
          и опыт работы. Импорт заменит текущие данные на импортированные.
        </p>
        <div class="import-export-buttons">
          <button
            type="button"
            color="accent"
            mat-flat-button
            (click)="exportData('json')"
          >
            Экспорт JSON
          </button>
          <button
            type="button"
            color="accent"
            mat-flat-button
            (click)="exportData('xml')"
          >
            Экспорт XML
          </button>
          <input
            hidden
            type="file"
            #importFile
            accept=".json,.xml"
            (change)="importData($event)"
          >
          <button
            type="button"
            color="accent"
            mat-flat-button
            (click)="importFile.click()"
          >
            Импорт данных
          </button>
        </div>
      </mat-card>
    </div>

    <!-- Подписка -->
    <div class="full-width" appearance="outlined">
      <app-subscription />
    </div>

    <!-- Настройка вида сайта -->
    <mat-card class="full-width mb-2" appearance="outlined">
      <app-theme-picker />

      <mat-card-content class="cursor-toggle-section">
        <mat-slide-toggle
          [checked]="themeService.isCursorsEnabled()"
          (change)="themeService.toggleCursors($event.checked)">
          Кастомные курсоры
        </mat-slide-toggle>
        <mat-icon class="hint-icon" matTooltip="Включите для использования анимированных курсоров">help_outline</mat-icon>
      </mat-card-content>
    </mat-card>

    <!-- Удалить профиль -->
    <mat-card class="full-width p" appearance="outlined">
      <div class="delete-profile-wrapper">
        <button
          color="warn"
          type="button"
          mat-flat-button
          (click)="deleteProfile()"
          class="mb full-width error with-background"
        >
          Удалить мой профиль
        </button>
        <strong>Внимание: это действие необратимо. Все ваши данные будут удалены.</strong>
      </div>
    </mat-card>

    @if (unsavedChanges) {
    <div class="save-button-wrapper">
      <button type="button" mat-flat-button color="primary" class="save-button" (click)="saveChanges()">
        @if (changesSaving) {
          <mat-spinner diameter="20"></mat-spinner>
        } @else {
          Сохранить изменения
        }
      </button>
    </div>
    }
  }
</mat-card>
